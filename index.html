<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>スタンプカード</title>
<style>
  /* --- 基本レイアウトと変数定義 --- */
  :root {
    --w: 420px; /* 全体の横幅 */
    --primary-color: #007bff;
    --primary-color-dark: #0056b3;
    --light-gray: #f8f9fa;
    --gray: #6c757d;
    --border-color: #dee2e6;
    --border-radius: 10px;
    --shadow: 0 2px 8px rgba(0,0,0,.07);
  }
  html,body {
    height: 100%;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    margin: 0;
    display: flex;
    flex-direction: column;
    background-color: var(--light-gray);
    color: #333;
    line-height: 1.5;
  }
  main {
    width: min(100%, var(--w));
    padding: 8px;
    box-sizing: border-box;
    flex-grow: 1;
    margin: 0 auto;
  }
  /* --- コンポーネントのスタイル --- */
  .header {
    text-align: center;
    margin-bottom: 16px;
    padding: 12px 0;
  }
  .header h1 {
    font-size: 24px;
    font-weight: 700;
    color: #222;
    margin: 0 0 12px;
  }
  section {
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 16px;
    margin: 12px 0;
    box-shadow: var(--shadow);
  }
  h2 {
    font-size: 18px;
    margin: 0 0 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #333;
    font-weight: 600;
  }
  h2 .icon {
    width: 22px;
    height: 22px;
    color: var(--primary-color);
  }
  label {
    display: block;
    margin: 10px 0 5px;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray);
  }
  input {
    box-sizing: border-box;
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 16px;
    background: #fff;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
  }
  button {
    cursor: pointer;
    border: 0;
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 16px;
    font-weight: 600;
    transition: background-color 0.2s, transform 0.1s;
    width: 100%;
  }
  button:active {
    transform: scale(0.98);
  }
  .btn {
    background: var(--primary-color);
    color: #fff;
  }
  .btn:hover {
    background: var(--primary-color-dark);
  }
  .btn.secondary {
    background: #e9ecef;
    color: #333;
  }
  .btn.secondary:hover {
    background: #dae0e5;
  }
  .row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  /* --- メッセージ表示用のスタイル --- */
  #msg, #authMsg, #redeemMsg, #result {
    margin-top: 10px;
    min-height: 1.2em;
    font-size: 14px;
    text-align: center;
  }
  .ok   { color: #28a745; font-weight: 600; }
  .warn { color: #ffc107; font-weight: 600; }
  .err  { color: #dc3545; font-weight: 600; }
  /* --- ポイント表示用のスタイル --- */
  .pill {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 999px;
    background: var(--primary-color);
    color: #fff;
    font-weight: 700;
    font-size: 18px;
    line-height: 1;
  }
  small {
    display: block;
    margin-top: 10px;
    font-size: 12px;
    color: var(--gray);
    text-align: center;
  }
  /* --- フッターのスタイル --- */
  footer {
    text-align: center;
    padding: 16px;
    box-sizing: border-box;
    width: min(100%, var(--w));
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  #who  {
    font-size: 13px;
    color: var(--gray);
  }
  #topLogout {
    font-size: 13px;
    padding: 6px 12px;
    width: auto;
  }
  /* --- スタンプカードUIのスタイル --- */
  #stamp-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background-color: #fff;
  }
  .stamp-slot {
    width: 100%;
    padding-bottom: 100%; /* アスペクト比を1:1（正方形）に保つ */
    position: relative;
    background-color: var(--light-gray);
    border-radius: 50%;
    border: 2px solid var(--border-color);
  }
  .stamp-slot.filled {
    background-color: #ffd700; /* スタンプ獲得済みの色 */
    border-color: #e6c200;
    color: white;
  }
  .stamp-slot.filled::before {
    content: '★'; /* スタンプのアイコン */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    transition: color 0.3s;
  }
  /* 新しく追加されたスタンプのアニメーション用 */
  .stamp-slot.newly-added::before {
    color: #28a745; /* アニメーション時の色 */
  }
  /* スタンプ付与時のフィードバックメッセージ */
  #stamp-feedback {
    margin-left: auto; /* 右寄せ */
    font-size: 14px;
    font-weight: normal;
    color: #28a745;
  }
</style>
</head>
<body>
<main>
  <div class="header">
    <h1>スタンプカード</h1>
    <div id="points-display" style="display:none; margin-bottom: 12px; position: relative;">
      <span id="points" class="pill"></span>
    </div>
  </div>

  <!-- =================================================================
  認証セクション（未ログイン時に表示）
  ================================================================== -->
  <section id="auth">
    <h2>
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
      ログイン
    </h2>
    <label for="email">メールアドレス</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="username" />
    <div class="row">
      <button class="btn" id="sendCode">コード送信</button>
    </div>

    <div id="otpArea" style="display:none;margin-top:16px;">
      <label for="code">受信した6桁コード</label>
      <input id="code" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="123456" />
      <div class="row">
        <button class="btn" id="verify">認証してログイン</button>
      </div>
    </div>
    <div id="authMsg"></div>
    <small>※コードは10分有効です。届かない場合は迷惑メールフォルダをご確認ください。</small>
  </section>

  <!-- =================================================================
  スタンプカードセクション（ログイン時に表示）
  ================================================================== -->
  <section id="stamp-card-container" style="display:none;">
    <h2>
      <span>現在のスタンプ</span>
      <span id="stamp-feedback"></span>
    </h2>
    <div id="stamp-grid"></div>
  </section>

  <!-- =================================================================
  特典交換セクション（ログイン時に表示）
  ================================================================== -->
  <section id="redeem" style="display:none;">
    <h2>
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a8.25 8.25 0 01-16.5 0v-8.25a8.25 8.25 0 0116.5 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 15.75a3.75 3.75 0 003.75-3.75h-7.5a3.75 3.75 0 003.75 3.75z" /></svg>
      特典と交換（店員操作）
    </h2>
    <div class="row">
      <button class="btn" id="redeemBtn">10ptで特典と交換する</button>
    </div>
    <div id="redeemMsg"></div>
  </section>

  <!-- =================================================================
  PIN入力モーダル
  ================================================================== -->
  <div id="pinModal" style="display:none;">
    <div id="pinOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;"></div>
    <div id="pinDialog" style="position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#fff;border:1px solid var(--border-color);border-radius:var(--border-radius);padding:20px;z-index:10000;width:min(90%,320px);box-shadow:var(--shadow);">
      <h3 style="margin-top:0;font-size:18px;margin-bottom:12px;">4桁PINを入力</h3>
      <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" style="width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;font-size:18px;margin-bottom:16px;" autocomplete="one-time-code" />
      <div style="display:flex;gap:8px;">
        <button id="pinCancel" class="btn secondary" style="flex:1;">キャンセル</button>
        <button id="pinOk" class="btn" style="flex:1;">OK</button>
      </div>
    </div>
  </div>

  <div id="msg"></div>
  <div id="result"></div>
</main>
<footer id="user-info" style="display:none;">
  <span id="who"></span>
  <button id="topLogout" class="btn secondary">ログアウト</button>
</footer>

<script>
// --- グローバル設定 ---

/** @type {string} Google Apps Script のウェブアプリURL */
const API = "https://script.google.com/macros/s/AKfycbxOR48ttoDzNqza-LOukLSh1YgSRH6lyJQtiJ0Ft3lApK-pEbeZF0h8FqQff2Lohs-Wgg/exec";

/** @type {string} 認証トークン（LocalStorageから読み込み） */
let TOKEN = localStorage.getItem("token") || "";
/** @type {string} ユーザーのメールアドレス（LocalStorageから読み込み） */
let USER_EMAIL = localStorage.getItem("email") || "";


// --- API通信 ---

/**
 * GASエンドポイントにJSONデータをPOSTする
 * CORSのプリフライトリクエストを避けるためContent-Typeをtext/plainにしている
 * @param {object} payload - 送信するデータ
 * @returns {Promise<object>} - サーバーからのJSONレスポンス
 */
async function postJSON(payload) {
  const res = await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload)
  });
  // サーバーは常にJSON形式で {ok: boolean, ...} を返すと想定
  return res.json();
}


// --- DOM操作ユーティリティ ---

/**
 * document.getElementByIdのショートカット
 * @param {string} id - 要素のID
 * @returns {HTMLElement}
 */
const $ = (id) => document.getElementById(id);

/**
 * 要素の表示・非表示を切り替える
 * @param {HTMLElement} el - 対象の要素
 * @param {boolean} visible - 表示する場合はtrue
 */
const show = (el, visible) => {
  if (el) {
    el.style.display = visible ? 'block' : 'none';
  }
};


// --- UI制御 ---

/**
 * ログイン状態に応じて画面の表示を切り替える
 * @param {boolean} isLoggedIn - ログインしているかどうか
 */
function setLoginState(isLoggedIn) {
  show($("auth"), !isLoggedIn); // 認証フォーム
  show($("stamp-card-container"), isLoggedIn); // スタンプカード
  show($("redeem"), isLoggedIn); // 特典交換
  show($("user-info"), isLoggedIn); // フッターのユーザー情報
  show($("points-display"), isLoggedIn); // ヘッダーのポイント表示

  // 状態に関わらず、OTP入力フォームは一旦非表示にする
  show($("otpArea"), false);

  // ログアウト時は関連情報をクリア
  if (!isLoggedIn) {
    $("points").textContent = "";
    $("authMsg").textContent = "";
    $("authMsg").className = "";
    if ($("who")) $("who").textContent = "";
  } else if (USER_EMAIL) {
    if ($("who")) $("who").textContent = `ログイン中: ${USER_EMAIL}`;
  }
}

/**
 * スタンプカードの表示を更新する
 * @param {number} points - 現在のポイント数
 * @param {boolean} [isNew=false] - 新規スタンプが付与された直後か
 */
function updateStampCard(points, isNew = false) {
  const grid = $('stamp-grid');
  grid.innerHTML = ''; // 既存の表示をクリア
  const displayStamps = Math.min(points, 30); // 表示上限は30個
  for (let i = 0; i < 30; i++) {
    const slot = document.createElement('div');
    slot.className = 'stamp-slot';
    if (i < displayStamps) {
      slot.classList.add('filled');
      // 新規スタンプの場合、最後に追加されたものにアニメーション用クラスを付与
      if (isNew && i === points - 1) {
        slot.classList.add('newly-added');
      }
    }
    grid.appendChild(slot);
  }
}

/**
 * サーバーから現在のユーザー情報を取得し、UIを更新する
 * @param {boolean} [isNewStamp=false] - 新規スタンプが付与された直後か
 */
async function loadStatus(isNewStamp = false) {
  if (!TOKEN) return;
  try {
    const r = await postJSON({ action: "me", token: TOKEN });
    if (r.ok) {
      // ポイントとスタンプカード表示を更新
      show($("points-display"), true);
      $("points").textContent = `現在 ${r.points} pt`;
      updateStampCard(r.points, isNewStamp);

      // 新規スタンプの場合のみフィードバックメッセージを表示
      const feedbackEl = $('stamp-feedback');
      if (isNewStamp) {
        feedbackEl.textContent = 'スタンプを1つ付与しました';
      } else {
        feedbackEl.textContent = ''; // それ以外はクリア
      }

      // メールアドレスを更新
      if (r.email && r.email !== USER_EMAIL) {
        USER_EMAIL = r.email;
        localStorage.setItem("email", USER_EMAIL);
      }
      if (USER_EMAIL) {
        $("who").textContent = `ログイン中: ${USER_EMAIL}`;
      }
    } else {
      // トークンが無効な場合は強制ログアウト
      doLogout(true, "セッションが切れました。再ログインしてください。");
    }
  } catch (_) {
    // ネットワークエラーなどは無視
  }
}


// --- 認証フロー ---

/**
 * [コード送信]ボタンのクリックイベント
 * メールアドレス宛にOTP（ワンタイムパスワード）を送信するようサーバーにリクエスト
 */
$("sendCode").addEventListener("click", async () => {
  const email = $("email").value.trim();
  if (!email) {
    $("authMsg").textContent = "メールを入力してください";
    $("authMsg").className="err";
    return;
  }
  $("authMsg").textContent = "送信中…";
  $("authMsg").className="";
  try {
    const r = await postJSON({ action: "auth_start", email });
    if (r.ok) {
      $("authMsg").textContent = "コードを送信しました。メールを確認してください。";
      $("authMsg").className = "ok";
      show($("otpArea"), true); // OTP入力欄を表示
    } else {
      $("authMsg").textContent = r.error || "送信に失敗しました";
      $("authMsg").className = "err";
    }
  } catch (e) {
    $("authMsg").textContent = "通信エラー: " + e;
    $("authMsg").className = "err";
  }
});

/**
 * [認証してログイン]ボタンのクリックイベント
 * 入力されたOTPをサーバーで検証し、成功すればトークンを取得してログイン
 */
$("verify").addEventListener("click", async () => {
  const email = $("email").value.trim();
  const code  = $("code").value.trim();
  if (!email || !code) {
    $("authMsg").textContent = "メールとコードを入力";
    $("authMsg").className="err";
    return;
  }
  $("authMsg").textContent = "検証中…";
  $("authMsg").className="";
  try {
    const r = await postJSON({ action: "auth_verify", email, code });
    if (r.ok && r.token) {
      USER_EMAIL = email;
      localStorage.setItem("email", USER_EMAIL);
      $("authMsg").textContent = "ログイン成功";
      $("authMsg").className = "ok";
      
      await doLogin(r.token);

      // ログイン直後にURLにスタンプ用のパラメータがあれば、スタンプ処理を実行
      const urlParamsAfterLogin = new URLSearchParams(window.location.search);
      const payloadAfterLogin = urlParamsAfterLogin.get('q');
      if (payloadAfterLogin) {
        $("result").textContent = ""; // メッセージをクリア
        await sendStamp(payloadAfterLogin);
        // 処理後はURLからパラメータを除去
        history.replaceState(null, '', window.location.pathname);
      }
    } else {
      $("authMsg").textContent = r.error || "認証失敗";
      $("authMsg").className = "err";
    }
  } catch (e) {
    $("authMsg").textContent = "通信エラー: " + e;
    $("authMsg").className = "err";
  }
});


// --- ログイン・ログアウト処理 ---

/**
 * ログイン処理を実行する
 * @param {string} token - サーバーから取得した認証トークン
 */
async function doLogin(token) {
  TOKEN = token;
  localStorage.setItem("token", TOKEN);
  setLoginState(true);
  await loadStatus();
}

/**
 * ログアウト処理を実行する
 * @param {boolean} [isExpired=false] - セッション切れによるログアウトか
 * @param {string} [msg="ログアウトしました"] - 表示するメッセージ
 */
function doLogout(isExpired = false, msg = "ログアウトしました") {
  TOKEN = "";
  USER_EMAIL = "";
  localStorage.removeItem("token");
  localStorage.removeItem("email");
  setLoginState(false);
  $("msg").textContent = msg;
  $("msg").className = isExpired ? "warn" : "ok";
  $("result").textContent = "";
  $("stamp-feedback").textContent = "";
}

/**
 * [ログアウト]ボタンのクリックイベント
 */
$("topLogout").addEventListener("click", () => doLogout());


// --- スタンプ・特典交換機能 ---

/**
 * サーバーにスタンプ付与をリクエストする
 * @param {string} payload - QRコードから読み取ったペイロード
 */
async function sendStamp(payload) {
  $("result").textContent = ""; // 古いメッセージをクリア
  try {
    const r = await postJSON({ action: "stamp", token: TOKEN, qr_payload: payload });
    if (r.ok) {
      // 成功した場合、サーバーから返された最新のポイント数でUIを更新
      const pts = r.points;
      show($("points-display"), true);
      $("points").textContent = `現在 ${pts} pt`;
      updateStampCard(pts, true); // 新規スタンプとしてUI更新
      $("stamp-feedback").textContent = "スタンプを1つ付与しました";
    } else {
      $("result").textContent = r.error || "スタンプ処理に失敗";
      $("result").className = "err";
    }
  } catch (e) {
    $("result").textContent = "通信エラー: " + e;
    $("result").className = "err";
  }
}

/**
 * [特典と交換する]ボタンのクリックイベント
 */
$("redeemBtn").addEventListener("click", async () => {
  // PIN入力モーダルを表示し、入力結果を取得
  const pin = await showPinDialog();
  if (!pin) {
    return; // キャンセルされた場合
  }
  $("redeemMsg").textContent = "処理中…";
  $("redeemMsg").className = "";
  try {
    const r = await postJSON({ action: "redeem", token: TOKEN, pin });
    if (r.ok) {
      $("redeemMsg").textContent = `引換成功！ Ticket: ${r.ticket}`;
      $("redeemMsg").className = "ok";
      await loadStatus(); // ポイントを再読み込みしてUIを更新
    } else {
      $("redeemMsg").textContent = r.error || "引換失敗";
      $("redeemMsg").className = "err";
    }
  } catch (e) {
    $("redeemMsg").textContent = "通信エラー: " + e;
    $("redeemMsg").className = "err";
  }
});

/**
 * 4桁のPINコードを入力するためのモーダルダイアログを表示する
 * @returns {Promise<string|null>} - 入力されたPINコード、またはキャンセルされた場合はnull
 */
function showPinDialog() {
  return new Promise((resolve) => {
    const modal    = $("pinModal");
    const input    = $("pinInput");
    const btnOk    = $("pinOk");
    const btnCancel= $("pinCancel");
    
    input.value = "";
    modal.style.display = "block";

    // イベントハンドラを定義
    const onOk = () => {
      const val = input.value.trim();
      if (val.length === 4 && /^[0-9]+$/.test(val)) {
        close(val);
      } else {
        input.focus(); // 不正な入力の場合は再度フォーカス
      }
    };
    const onCancel = () => close(null);
    const onKey = (ev) => {
      if (ev.key === 'Enter') onOk();
      if (ev.key === 'Escape') onCancel();
    };
    
    // ダイアログを閉じる際のクリーンアップ処理
    const close = (result) => {
      modal.style.display = "none";
      btnOk.removeEventListener("click", onOk);
      btnCancel.removeEventListener("click", onCancel);
      input.removeEventListener("keypress", onKey);
      resolve(result);
    };

    // イベントリスナーを設定
    btnOk.addEventListener("click", onOk);
    btnCancel.addEventListener("click", onCancel);
    input.addEventListener("keypress", onKey);
    
    // 入力欄にフォーカス
    setTimeout(() => input.focus(), 0);
  });
}


// --- 初期化処理 ---

/**
 * ページ読み込み時の初期化処理
 */
(async () => {
  // 1. LocalStorageのトークンを元に、まずログイン状態をUIに反映
  setLoginState(!!TOKEN);

  // 2. URLにQRコードのペイロード(?q=...)があるかチェック
  const urlParams = new URLSearchParams(window.location.search);
  const qrPayloadFromUrl = urlParams.get('q');

  // 3. ログイン済みで、かつURLにペイロードがある場合
  if (qrPayloadFromUrl && TOKEN) {
    // スタンプを付与し、処理後にURLからパラメータを削除
    await sendStamp(qrPayloadFromUrl);
    history.replaceState(null, '', window.location.pathname);
  } 
  // 4. それ以外の場合
  else {
    // ログイン済みであれば、通常通りユーザー情報を読み込む
    if (TOKEN) {
      await loadStatus();
    }
    // 未ログインで、かつURLにペイロードがある場合は、ログインを促すメッセージを表示
    if (qrPayloadFromUrl && !TOKEN) {
      $("authMsg").textContent = "ポイントを付けるにはログインしてください";
      $("authMsg").className = "warn";
    }
  }
})();
</script>
</body>
</html>
