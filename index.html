<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>スタンプカード</title>
<style>
  :root {
    --w: 420px;
    --primary-color: #007bff;
    --primary-color-dark: #0056b3;
    --light-gray: #f8f9fa;
    --gray: #6c757d;
    --border-color: #dee2e6;
    --border-radius: 10px;
    --shadow: 0 2px 8px rgba(0,0,0,.07);
  }
  html,body {
    height: 100%;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    margin: 0;
    display: flex;
    flex-direction: column;
    background-color: var(--light-gray);
    color: #333;
    line-height: 1.5;
  }
  main {
    width: min(100%, var(--w));
    padding: 8px;
    box-sizing: border-box;
    flex-grow: 1;
    margin: 0 auto;
  }
  .header {
    text-align: center;
    margin-bottom: 16px;
    padding: 12px 0;
  }
  .header h1 {
    font-size: 24px;
    font-weight: 700;
    color: #222;
    margin: 0 0 12px;
  }
  section {
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 16px;
    margin: 12px 0;
    box-shadow: var(--shadow);
  }
  h2 {
    font-size: 18px;
    margin: 0 0 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #333;
    font-weight: 600;
  }
  h2 .icon {
    width: 22px;
    height: 22px;
    color: var(--primary-color);
  }
  label {
    display: block;
    margin: 10px 0 5px;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray);
  }
  input {
    box-sizing: border-box;
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 16px;
    background: #fff;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
  }
  button {
    cursor: pointer;
    border: 0;
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 16px;
    font-weight: 600;
    transition: background-color 0.2s, transform 0.1s;
    width: 100%;
  }
  button:active {
    transform: scale(0.98);
  }
  .btn {
    background: var(--primary-color);
    color: #fff;
  }
  .btn:hover {
    background: var(--primary-color-dark);
  }
  .btn.secondary {
    background: #e9ecef;
    color: #333;
  }
  .btn.secondary:hover {
    background: #dae0e5;
  }
  .row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  #reader {
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    overflow: hidden;
    margin-top: 12px;
  }
  #msg, #authMsg, #redeemMsg, #result {
    margin-top: 10px;
    min-height: 1.2em;
    font-size: 14px;
    text-align: center;
  }
  .ok   { color: #28a745; font-weight: 600; }
  .warn { color: #ffc107; font-weight: 600; }
  .err  { color: #dc3545; font-weight: 600; }
  .pill {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 999px;
    background: var(--primary-color);
    color: #fff;
    font-weight: 700;
    font-size: 18px;
    line-height: 1;
  }
  small {
    display: block;
    margin-top: 10px;
    font-size: 12px;
    color: var(--gray);
    text-align: center;
  }
  footer {
    text-align: center;
    padding: 16px;
    box-sizing: border-box;
    width: min(100%, var(--w));
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  #who  {
    font-size: 13px;
    color: var(--gray);
  }
  #topLogout {
    font-size: 13px;
    padding: 6px 12px;
    width: auto;
  }
</style>
</head>
<body>
<main>
  <div class="header">
    <h1>スタンプカード</h1>
    <div id="points-display" style="display:none; margin-bottom: 12px;">
      <span id="points" class="pill"></span>
    </div>
  </div>

  <!-- 認証（メールOTP）: ログイン済みなら丸ごと非表示 -->
  <section id="auth">
    <h2>
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
      ログイン
    </h2>
    <label for="email">メールアドレス</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
    <div class="row">
      <button class="btn" id="sendCode">コード送信</button>
    </div>

    <div id="otpArea" style="display:none;margin-top:16px;">
      <label for="code">受信した6桁コード</label>
      <input id="code" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="123456" />
      <div class="row">
        <button class="btn" id="verify">認証してログイン</button>
      </div>
    </div>
    <div id="authMsg"></div>
    <small>※コードは10分有効です。届かない場合は迷惑メールフォルダをご確認ください。</small>
  </section>

  <!-- スキャン（ログイン済みのみ表示） -->
  <section id="scan" style="display:none;">
    <h2>
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5a3 3 0 00-3 3v10.5a3 3 0 003 3h10.5a3 3 0 003-3V7.5a3 3 0 00-3-3H3.75zM14.25 8.625a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0zM16.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>
      スタンプを貯める
    </h2>
    <div class="row">
      <button class="btn" id="startScan">QRコードをスキャン</button>
      <button class="btn secondary" id="stopScan" disabled>停止</button>
    </div>
    <div id="reader"></div>

    <div id="result"></div>
  </section>

  <!-- 引換（店員用、ログイン済みのみ表示） -->
  <section id="redeem" style="display:none;">
    <h2>
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.25v8.25a8.25 8.25 0 01-16.5 0v-8.25a8.25 8.25 0 0116.5 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 15.75a3.75 3.75 0 003.75-3.75h-7.5a3.75 3.75 0 003.75 3.75z" /></svg>
      特典と交換（店員操作）
    </h2>
    <input id="pin" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="4桁のPIN" />
    <div class="row">
      <button class="btn" id="redeemBtn">10ptで特典と交換する</button>
    </div>
    <div id="redeemMsg"></div>
  </section>

  <div id="msg"></div>
</main>
<footer id="user-info" style="display:none;">
  <span id="who"></span>
  <button id="topLogout" class="btn secondary">ログアウト</button>
</footer>

<!-- QRライブラリ -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/** あなたのGASウェブアプリURL（/exec） */
const API = "https://script.google.com/macros/s/AKfycbxOR48ttoDzNqza-LOukLSh1YgSRH6lyJQtiJ0Ft3lApK-pEbeZF0h8FqQff2Lohs-Wgg/exec";

/** CORS簡略化のため Content-Type: text/plain（プリフライト回避） */
async function postJSON(payload) {
  const res = await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload)
  });
  return res.json(); // 失敗も {ok:false,error:"..."} を返す想定
}

/** ユーティリティ */
const $ = (id) => document.getElementById(id);
const show = (el, on) => (el.style.display = on ? "" : "none");

/** 状態 */
let TOKEN = localStorage.getItem("token") || "";
let USER_EMAIL = localStorage.getItem("email") || "";

/** 画面出し分け（ログイン済みならauthを隠す） */
function setLoginState(loggedIn) {
  show($("auth"),   !loggedIn);
  show($("scan"),    loggedIn);
  show($("redeem"),  loggedIn);

  show($("user-info"), loggedIn);
  $("who").textContent = loggedIn ? `ログイン中: ${USER_EMAIL || "-"}` : "";

  if (!loggedIn) {
    show($("points-display"), false);
    $("points").textContent = "";
    $("authMsg").textContent = "";
    $("authMsg").className = "";
  }
}

/** 現在ポイントの読み込み（必要ならメールも補完） */
async function loadStatus() {
  if (!TOKEN) return;
  try {
    const r = await postJSON({ action: "me", token: TOKEN });
    if (r.ok) {
      show($("points-display"), true);
      $("points").textContent = `現在 ${r.points} pt`;
      if (r.email && !USER_EMAIL) {
        USER_EMAIL = r.email;
        localStorage.setItem("email", USER_EMAIL);
        $("who").textContent = `ログイン中: ${USER_EMAIL}`;
      }
    } else {
      doLogout(true, "セッションが切れました。再ログインしてください。");
    }
  } catch (_) { /* オフライン等は無視 */ }
}

/** ===== 認証（メールOTP） ===== */
$("sendCode").addEventListener("click", async () => {
  const email = $("email").value.trim();
  if (!email) { $("authMsg").textContent = "メールを入力してください"; $("authMsg").className="err"; return; }
  $("authMsg").textContent = "送信中…"; $("authMsg").className="";
  try {
    const r = await postJSON({ action: "auth_start", email });
    if (r.ok) {
      $("authMsg").textContent = "コードを送信しました。メールを確認してください。";
      $("authMsg").className = "ok";
      show($("otpArea"), true);
    } else {
      $("authMsg").textContent = r.error || "送信に失敗しました";
      $("authMsg").className = "err";
    }
  } catch (e) {
    $("authMsg").textContent = "通信エラー: " + e;
    $("authMsg").className = "err";
  }
});

$("verify").addEventListener("click", async () => {
  const email = $("email").value.trim();
  const code  = $("code").value.trim();
  if (!email || !code) { $("authMsg").textContent = "メールとコードを入力"; $("authMsg").className="err"; return; }
  $("authMsg").textContent = "検証中…"; $("authMsg").className="";
  try {
    const r = await postJSON({ action: "auth_verify", email, code });
    if (r.ok && r.token) {
      TOKEN = r.token;
      USER_EMAIL = email;
      localStorage.setItem("token", TOKEN);
      localStorage.setItem("email", USER_EMAIL);
      $("authMsg").textContent = "ログイン成功";
      $("authMsg").className = "ok";
      setLoginState(true);
      await loadStatus();
    } else {
      $("authMsg").textContent = r.error || "認証失敗";
      $("authMsg").className = "err";
    }
  } catch (e) {
    $("authMsg").textContent = "通信エラー: " + e;
    $("authMsg").className = "err";
  }
});

function doLogout(isExpired = false, msg = "ログアウトしました") {
  TOKEN = "";
  USER_EMAIL = "";
  localStorage.removeItem("token");
  localStorage.removeItem("email");
  setLoginState(false);
  $("msg").textContent = msg;
  $("msg").className = isExpired ? "warn" : "ok";
}
$("topLogout").addEventListener("click", () => doLogout());


/** ===== QRスキャン ===== */
const html5QrCode = new Html5Qrcode("reader");

$("startScan").addEventListener("click", () => {
  $("startScan").disabled = true;
  $("stopScan").disabled = false;
  $("result").textContent = "カメラを起動中…";
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };
  html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
});

$("stopScan").addEventListener("click", async () => {
  try {
    await html5QrCode.stop();
    $("startScan").disabled = false;
    $("stopScan").disabled = true;
    $("result").textContent = "カメラを停止しました";
  } catch(e) { /* ignore */ }
});

async function onScanSuccess(decodedText, decodedResult) {
  await $("stopScan").click(); // スキャン成功したら止める
  $("result").textContent = "QRコードを読み取りました。通信中…";
  $("result").className = "";

  // URLからペイロードを抽出
  let payload = decodedText;
  try {
    const url = new URL(decodedText);
    if (url.searchParams.has('q')) {
      payload = url.searchParams.get('q');
    }
  } catch(e) {
    // URLでなければ、スキャンしたテキスト全体をペイロードとして扱う
  }
  await sendStamp(payload);
}

function onScanFailure(error) { /* 毎回呼ばれるので無視 */ }

async function sendStamp(payload) {
  try {
    const r = await postJSON({ action: "stamp", token: TOKEN, qr_payload: payload });
    if (r.ok) {
      $("result").textContent = `スタンプを押しました！ → 現在 ${r.points} pt`;
      $("result").className = "ok";
      await loadStatus(); // ポイントを再読み込み
    } else {
      $("result").textContent = r.error || "スタンプ処理に失敗";
      $("result").className = "err";
    }
  } catch (e) {
    $("result").textContent = "通信エラー: " + e;
    $("result").className = "err";
  }
}

/** ===== 特典引換 ===== */
$("redeemBtn").addEventListener("click", async () => {
  const pin = $("pin").value;
  if (!pin) { $("redeemMsg").textContent = "PINを入力してください"; $("redeemMsg").className="err"; return; }
  $("redeemMsg").textContent = "処理中…"; $("redeemMsg").className="";
  try {
    const r = await postJSON({ action: "redeem", token: TOKEN, pin });
    if (r.ok) {
      $("redeemMsg").textContent = `引換成功！ Ticket: ${r.ticket}`;
      $("redeemMsg").className = "ok";
      await loadStatus(); // ポイントを再読み込み
    } else {
      $("redeemMsg").textContent = r.error || "引換失敗";
      $("redeemMsg").className = "err";
    }
  } catch (e) {
    $("redeemMsg").textContent = "通信エラー: " + e;
    $("redeemMsg").className = "err";
  }
});

// 初期化
setLoginState(!!TOKEN);
loadStatus(); // 起動時に現在ポイントを表示（tokenが有効なら）

// ページ読み込み時にURLパラメータをチェック
const urlParams = new URLSearchParams(window.location.search);
const qrPayloadFromUrl = urlParams.get('q');
if (qrPayloadFromUrl && TOKEN) {
  // ログイン済みで、URLに 'q' パラメータがある場合、自動でスタンプ処理を実行
  $("result").textContent = "URLからスタンプ情報を読み込みました。処理中…";
  $("result").className = "";
  sendStamp(qrPayloadFromUrl);
}
</script>
</body>
</html>
